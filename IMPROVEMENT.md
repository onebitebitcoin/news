# IMPROVEMENT

- 작성일(KST): 2026-02-14
- 대상: `bitcoin-news` 프로젝트 구조/운영/품질 개선
- 범위: 코드 변경 없이 구조 분석 + 개선 적용 시 기능 리스크 검토

## 1) 분석 방법
1. `SPEC.md` 요구사항과 실제 구현 간 갭 분석
2. Backend 진입점/설정/파이프라인/저장소 계층 검토
3. Frontend 라우팅/상태관리/에러표시/UX 흐름 검토
4. 테스트 구조/커버리지/운영 스크립트 검토
5. 각 개선안에 대해 "적용 시 기능 오동작 가능성"과 완화책 도출

## 2) 구조적 결함 및 개선안

### A. DB 스키마 변경 방식이 런타임 로직에 섞여 있음 (높음)
- 근거
  - `backend/app/database.py`의 `init_db()`에서 `create_all()` + 수동 `ALTER TABLE` + 백필 수행
  - Alembic 기반 정식 마이그레이션 체계 부재
- 문제
  - 배포 환경마다 스키마 상태가 달라질 수 있고, 장애 시 재현이 어려움
  - 앱 시작 시 DB 변경이 실행되어 startup 위험 증가
- 개선안
  - Alembic 도입, 스키마 변경을 버전화
  - startup에서는 마이그레이션 실행 금지, 운영 파이프라인에서 별도 실행

### B. API 응답 규격이 SPEC와 불일치 (높음)
- 근거
  - SPEC는 공통 envelope(`status/data/error/metadata`)를 정의했지만 현재 다수 endpoint는 raw payload 반환
- 문제
  - 클라이언트/외부 연동 시 endpoint별 파싱 분기 증가
  - 장애/오류 처리 일관성 저하
- 개선안
  - 공통 응답 스키마 적용 또는 최소한 endpoint 그룹별 응답 규약 통일

### C. 번역 실패 시 기사가 소실될 가능성 (높음)
- 근거
  - `TranslateStage`에서 배치 번역 예외 시 `context.items = []` 처리
- 문제
  - 수집 성공 데이터가 번역 실패만으로 저장되지 않음
  - 외부 API 장애가 내부 데이터 공백으로 직결
- 개선안
  - 번역 실패 시 원문으로 저장(fail-open)
  - 번역 상태 플래그를 별도 필드로 관리

### D. 저장 단계의 트랜잭션 경계가 아이템 단위 (중간)
- 근거
  - `PersistStage`에서 아이템마다 `commit()`
- 문제
  - 처리량 저하, 중간 실패 시 부분 저장/통계 불일치 가능
- 개선안
  - source 단위 트랜잭션 + 배치 flush/commit
  - 무결성 실패 아이템만 분리 처리

### E. 중복 체크가 N회 DB 조회 구조 (중간)
- 근거
  - `DedupStage`에서 아이템별 `is_duplicate()` 호출
- 문제
  - 수집량 증가 시 DB 왕복 과다
- 개선안
  - URL hash 일괄 조회 후 메모리 판정
  - DB unique index + 충돌 처리 병행

### F. API 키 평문 저장 (높음, 보안)
- 근거
  - `api_keys.key`를 평문 저장/조회
- 문제
  - DB 유출 시 즉시 악용 가능
- 개선안
  - 키는 생성 시 1회만 평문 노출, 저장은 해시(HMAC/sha256+salt)
  - prefix + hash 조회 방식으로 인증

### G. 외부 요청 타임아웃/재시도 정책의 표준화 부족 (중간)
- 근거
  - 서비스별 `httpx` 사용 패턴이 분산, backoff 정책 공통화 부족
- 문제
  - 소스 장애 시 일시적으로 실패율 급증
- 개선안
  - 공통 HTTP client 정책(타임아웃/재시도/회로차단) 도입

### H. 테스트가 핵심 회귀 포인트를 충분히 방어하지 못함 (중간)
- 근거
  - 현재 테스트는 기본 API/유틸 중심, 파이프라인 실패/번역 fail-open/그룹화 경계 테스트 부족
- 문제
  - 리팩토링 시 기능 회귀 탐지 한계
- 개선안
  - 파이프라인 단계별 계약 테스트 추가
  - 중복 그룹화/번역 실패/스케줄러 진행 상태 테스트 보강

### J. 라우트 설계는 기본 준수하나 상세 페이지 경로 부재 (낮음~중간)
- 근거
  - 현재 주요 페이지 라우트는 분리되어 있으나 feed 상세(`/item/:id`)는 외부 링크 중심
- 문제
  - 내부 탐색, 북마크-상세 전환, URL 공유 UX 약함
- 개선안
  - 상세 페이지 라우트 추가 및 내부 네비게이션 제공

## 3) 개선안 적용 시 기능 오동작 가능성 검토

### A. Alembic 도입/마이그레이션 전환
- 가능 오류
  - 누락된 migration으로 서버 startup 실패
  - 기존 SQLite 데이터와 모델 불일치
- 완화책
  - "현재 DB 스냅샷 -> baseline migration" 먼저 생성
  - CI에서 `alembic upgrade head` + smoke test 강제

### B. API 응답 envelope 통일
- 가능 오류
  - 기존 프론트가 raw 응답 가정 시 파싱 실패
  - 외부 API 사용자 호환성 깨짐
- 완화책
  - 버전 분리(`/api/v2`) 또는 점진 전환
  - 어댑터 레이어를 프론트에 임시 제공

### C. 번역 fail-open 전환
- 가능 오류
  - 원문/번역문 혼재로 UI 정렬/검색 품질 변동
  - 번역 성공률 KPI 해석 혼선
- 완화책
  - `translation_status` 필드(OK/FAILED/SKIPPED) 추가
  - UI에서 상태 기반 배지/필터 제공

### D. 저장 트랜잭션 배치화
- 가능 오류
  - 배치 하나 실패 시 전체 롤백으로 저장량 급감
  - deadlock/lock 대기(향후 DB 확장 시)
- 완화책
  - 배치 크기 제한(예: 50~100)
  - 실패 레코드 격리 재시도 큐 도입

### E. dedup 로직 최적화
- 가능 오류
  - 기준 변경 시 기존보다 중복 허용/과삭제 발생
  - group_id 계산과 충돌해 UI 중복 묶음 이상
- 완화책
  - 기존/신규 알고리즘 A/B 비교 로그
  - 기간 한정 shadow mode로 결과 차이 검증

### F. API 키 해시 저장 전환
- 가능 오류
  - 기존 키 인증 전면 실패(마이그레이션 누락 시)
  - 관리 화면에서 키 재표시 기대 동작 붕괴
- 완화책
  - 이행 기간 동안 평문+해시 이중 검증 허용
  - "기존 키 재발급 필요" 운영 가이드 동시 배포

### G. 공통 HTTP client 정책 도입
- 가능 오류
  - 재시도 과다로 지연 증가
  - 엄격한 timeout으로 성공 가능 요청 조기 실패
- 완화책
  - 소스별 정책 프로파일 분리(RSS/API/스크래핑)
  - 관측 지표(성공률, p95 지연) 기반 튜닝

### H. 테스트 확장
- 가능 오류
  - flaky test 증가로 배포 지연
- 완화책
  - 외부 의존은 mock/fake로 격리
  - 느린 테스트는 nightly, 핵심 회귀는 PR 필수

## 4) 우선순위 실행 제안
1. 마이그레이션 체계 정립(A)
2. 번역 fail-open 및 파이프라인 안정화(C, D)
3. API 키 보안 개선(F)
4. API 응답 규격 정리(B)
5. dedup/성능 최적화(E, G)
6. 테스트 확장(H)

## 5) 결론
현재 프로젝트는 기능 구현은 빠르게 진행된 상태이나, "운영 안정성/데이터 일관성/보안" 레이어가 상대적으로 취약하다. 특히 DB 변경 관리, 번역 실패 처리, 인증키 저장 방식은 기능 장애 또는 보안 사고로 직결될 수 있으므로 우선 개선이 필요하다.
